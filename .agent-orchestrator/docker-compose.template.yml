services:
  agent-workspace:
    image: migralog-agent-workspace:latest
    container_name: "agent-${AGENT_ID}"
    working_dir: /workspace
    volumes:
      # Mount parent repo as read-only for cloning
      - "${PROJECT_ROOT}:/host-repo:ro"

      # Docker access for nested containers
      - "/var/run/docker.sock:/var/run/docker.sock"

      # Host tool access (for full autonomy) - read-only
      - "${HOME}/.npmrc:/home/agent/.npmrc:ro"
      - "${HOME}/.gitconfig:/home/agent/.gitconfig:ro"

      # SSH keys for git push/pull authentication - read-only
      - "${HOME}/.ssh:/home/agent/.ssh:ro"

    environment:
      - NODE_ENV=development
      - AGENT_ID=${AGENT_ID}
      - AGENT_BRANCH=${BRANCH_NAME}
      - EXPO_PORT=${EXPO_PORT}
      - METRO_PORT=${METRO_PORT}
      - PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:/workspace/node_modules/.bin:/home/agent/tools

      # Grant full tool access
      - DEBIAN_FRONTEND=noninteractive
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      
    ports:
      - "${EXPO_PORT}:${EXPO_PORT}"   # Expo dev server
      - "${METRO_PORT}:${METRO_PORT}" # Metro bundler
      
    networks:
      - agent-network
      
    # Start in autonomous mode by default
    command: ["/home/agent/agent-startup.sh"]

    # Enhanced health check
    healthcheck:
      test: ["CMD-SHELL", "node --version && git --version && which opencode || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
      
    labels:
      - "agent.id=${AGENT_ID}"
      - "agent.type=autonomous-workspace"
      - "agent.tier=2"
      
    # Security context for full autonomy
    cap_add:
      - SYS_PTRACE  # For debugging tools
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

networks:
  agent-network:
    driver: bridge
    labels:
      - "agent.network=true"