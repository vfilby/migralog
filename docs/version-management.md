# Version Management Guide

This guide explains how version numbers and build numbers are managed in the MigraLog app.

## Overview

MigraLog uses a hybrid approach for version management:
- **Version Number**: Managed in `package.json` (single source of truth)
- **Build Number**: Auto-incremented by EAS Build on each build
- **Build Info**: Auto-generated at build time with version, build number, git commit, and timestamp

## Version Numbering (Semantic Versioning)

The app follows [Semantic Versioning](https://semver.org/) with the format: `MAJOR.MINOR.PATCH`

### When to Increment

- **MAJOR**: Breaking changes (e.g., major database schema changes requiring migration)
- **MINOR**: New features (e.g., adding HealthKit integration, new screens)
- **PATCH**: Bug fixes and minor improvements (e.g., fixing notification bugs)

### How to Bump Version

1. Update `package.json`:
   ```bash
   # For patch releases (1.0.0 → 1.0.1)
   npm version patch

   # For minor releases (1.0.1 → 1.1.0)
   npm version minor

   # For major releases (1.1.0 → 2.0.0)
   npm version major
   ```

2. Commit the version change:
   ```bash
   git add package.json
   git commit -m "chore: bump version to X.Y.Z"
   ```

3. Create a git tag (optional but recommended):
   ```bash
   git tag vX.Y.Z
   git push origin vX.Y.Z
   ```

The version will automatically be:
- Used in `app.config.js` (read from `package.json`)
- Included in `buildInfo.ts` (generated at build time)
- Displayed in Settings screen
- Stored in backup metadata

## Build Number Management

Build numbers are automatically managed by EAS Build using the `autoIncrement: true` setting in `eas.json`.

### How It Works

- **Local Development**: Build number is `"dev"` (placeholder)
- **EAS Builds**: Build number is auto-incremented with each build (1, 2, 3, ...)
- **iOS**: Maps to `CFBundleVersion` in Info.plist
- **Android**: Maps to `versionCode` in build.gradle

### Build Profiles

All EAS build profiles have `autoIncrement: true` enabled:
- **development**: Internal testing builds
- **preview**: TestFlight/internal distribution builds
- **production**: App Store submission builds

Build numbers increment independently per profile.

## Build Info System

The `buildInfo.ts` file is auto-generated by `scripts/generate-build-info.js` and contains:

```typescript
export const buildInfo = {
  version: "1.0.0",        // From package.json
  buildNumber: "123",      // From EAS_BUILD_NUMBER env var or "dev"
  commitHash: "a1b2c3d",   // From git
  branch: "main",          // From git
  buildTime: "2025-..."    // Build timestamp
};
```

### Generation Triggers

Build info is regenerated:
- Before starting dev server (`npm start`)
- Before running iOS/Android (`npm run ios`, `npm run android`)
- During E2E test builds (`npm run test:ui:build`)
- During EAS builds (via `prebuildCommand` in `eas.json`)

**Important**: The `prebuildCommand: "npm run generate-build-info"` in `eas.json` ensures the script runs during EAS builds with the actual `EAS_BUILD_NUMBER` environment variable. Without this hook, builds would show "dev" instead of the real build number.

### Viewing Build Info

Users can view version and build information in **Settings → About**:
- **Version**: Displays app version (e.g., "1.0.0")
- **Build**: Displays build number and commit hash (e.g., "123 (a1b2c3d)")

## Files Involved

### Configuration Files
- **`package.json`**: Source of truth for version number
- **`app.config.js`**: Expo configuration (reads version from package.json)
- **`eas.json`**: EAS Build configuration (autoIncrement enabled)

### Source Files
- **`scripts/generate-build-info.js`**: Script that generates buildInfo.ts
- **`src/buildInfo.ts`**: Auto-generated file with version/build info
- **`src/screens/SettingsScreen.tsx`**: Displays version info to users
- **`src/services/backupService.ts`**: Includes version in backup metadata

## EAS Build Workflow

### Development Build
```bash
eas build --profile development --platform ios
```
- Auto-increments build number
- Version from package.json
- Build info generated with EAS_BUILD_NUMBER

### Preview Build (TestFlight)
```bash
eas build --profile preview --platform ios --auto-submit
```
- Auto-increments build number
- Automatically submits to TestFlight
- Version must be bumped manually if needed

### Production Build (App Store)
```bash
eas build --profile production --platform ios
```
- Auto-increments build number
- Version should be bumped for each App Store release
- Requires manual submission via `eas submit`

## Best Practices

### Version Bumps
1. **Always bump version** before creating a production build for App Store
2. **Use semantic versioning** to communicate change significance
3. **Tag releases in git** to track which commit corresponds to each version
4. **Update CHANGELOG.md** (if maintained) with version changes

### Build Numbers
1. **Don't manually set** build numbers - let EAS handle it
2. **Build number must increase** for each TestFlight/App Store submission
3. **Reset only when necessary** (e.g., changing bundle identifier)

### Testing
1. **Verify version display** in Settings screen after bumping
2. **Check buildInfo.ts** is regenerated correctly
3. **Ensure app.config.js** loads without errors (`npx expo config`)

## Troubleshooting

### "Version already exists" Error (TestFlight)
**Problem**: Trying to submit same version with same/lower build number

**Solution**:
- Let EAS auto-increment handle build numbers (already configured)
- Bump version in package.json if starting a new release

### Build Info Shows "unknown"
**Problem**: Build info generation failed (usually in CI/CD)

**Solution**:
- Ensure git is available in build environment
- Check `generate-build-info.js` script execution
- Fallback values will be used if generation fails

### expo config Fails After Conversion
**Problem**: `app.config.js` syntax error or import issue

**Solution**:
```bash
# Test expo config loads correctly
npx expo config --type public

# Check for JavaScript syntax errors
node -c app.config.js
```

## Migration Notes

### Changed from app.json to app.config.js
- Allows dynamic version reading from `package.json`
- All existing configuration preserved
- No breaking changes for existing builds

### Removed Hardcoded APP_VERSION
- Previously hardcoded as `'1.0.0'` in backupService.ts
- Now reads from `buildInfo.version`
- Backups will include correct version automatically

## References

- [Expo App Versioning](https://docs.expo.dev/build-reference/app-versions/)
- [EAS Build Configuration](https://docs.expo.dev/build/eas-json/)
- [Semantic Versioning](https://semver.org/)
- [npm version command](https://docs.npmjs.com/cli/v8/commands/npm-version)
