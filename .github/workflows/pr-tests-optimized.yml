name: PR Tests (Optimized)

on:
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'app/**'
      - '.github/workflows/pr-tests-optimized.yml'

jobs:
  # Job 1: Fast Checks (Unit Tests, TypeScript, Lint)
  # Runs on Ubuntu for speed and cost efficiency
  # Provides fast feedback (~2 minutes) - fail fast strategy
  fast-checks:
    name: Fast Checks (Unit Tests, Types, Lint)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Expo Doctor (informational)
        run: npx expo-doctor
        continue-on-error: true

      - name: Run type checking
        run: npx tsc --noEmit

      - name: Run unit tests with coverage
        run: npm run test:ci

      - name: Run ESLint (errors only)
        run: npm run test:lint:ci

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          directory: ./app/coverage
          flags: unit
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-report
          path: app/coverage
          retention-days: 30

  # Note: iOS build and E2E tests removed from PR checks
  # These jobs are disabled until E2E tests can run reliably in CI runners
  # Run E2E tests locally with: npm run test:ui
  # Build iOS app locally with: npm run test:ui:build
