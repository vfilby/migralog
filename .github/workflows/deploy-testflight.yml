name: Deploy to TestFlight

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - '.github/workflows/deploy-testflight.yml'
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'EAS build profile to use'
        required: false
        default: 'preview'
        type: choice
        options:
          - preview
          - production

jobs:
  deploy:
    name: Build and Deploy to TestFlight
    runs-on: ubuntu-latest
    # Only run after CI tests pass on main
    # You can add a 'needs' dependency if you want to require ci.yml to pass first
    defaults:
      run:
        working-directory: ./app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Generate build info
        run: npm run generate-build-info

      - name: Build and Submit to TestFlight
        run: |
          # Use the build profile from workflow_dispatch input, or default to 'preview'
          BUILD_PROFILE="${{ github.event.inputs.build_profile || 'preview' }}"

          echo "Building iOS app with profile: $BUILD_PROFILE"
          eas build --platform ios --profile $BUILD_PROFILE --non-interactive --auto-submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Get build URL
        if: success()
        run: |
          echo "✅ Build submitted successfully!"
          echo "Check build status at: https://expo.dev/accounts/akin-gulp/projects/migraine-tracker/builds"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Build failed. Check the logs above for details."
          echo "Common issues:"
          echo "  - EXPO_TOKEN not set or invalid"
          echo "  - App Store Connect credentials not configured in EAS"
          echo "  - Build profile configuration errors in eas.json"
