name: Deploy to TestFlight

on:
  push:
    tags:
      - 'alpha-v*'
      - 'beta-v*'
      - 'v*'
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'EAS build profile to use'
        required: false
        default: 'preview'
        type: choice
        options:
          - preview
          - production

permissions:
  contents: write

jobs:
  deploy:
    name: Build and Deploy to TestFlight
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Determine build profile from tag
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG_NAME"

          if [[ "$TAG_NAME" == alpha-v* ]]; then
            echo "BUILD_PROFILE=preview" >> $GITHUB_ENV
            echo "RELEASE_TYPE=alpha" >> $GITHUB_ENV
            echo "üì± Building Alpha release with preview profile"
          elif [[ "$TAG_NAME" == beta-v* ]]; then
            echo "BUILD_PROFILE=preview" >> $GITHUB_ENV
            echo "RELEASE_TYPE=beta" >> $GITHUB_ENV
            echo "üì± Building Beta release with preview profile"
          elif [[ "$TAG_NAME" == v* ]]; then
            echo "BUILD_PROFILE=production" >> $GITHUB_ENV
            echo "RELEASE_TYPE=production" >> $GITHUB_ENV
            echo "üì± Building Production release with production profile"
          else
            # Manual workflow_dispatch trigger
            echo "BUILD_PROFILE=${{ github.event.inputs.build_profile || 'preview' }}" >> $GITHUB_ENV
            echo "RELEASE_TYPE=manual" >> $GITHUB_ENV
            echo "üì± Building manual release"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Generate build info
        run: npm run generate-build-info

      - name: Build and Submit to TestFlight
        run: |
          echo "Building iOS app for TestFlight"
          echo "Release type: $RELEASE_TYPE"
          echo "Build profile: $BUILD_PROFILE"
          eas build --platform ios --profile $BUILD_PROFILE --non-interactive --auto-submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.EXPO_PUBLIC_SENTRY_DSN }}
          EXPO_PUBLIC_SENTRY_ENABLED: "true"
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          # Allow Sentry sourcemap upload to fail without blocking the build
          SENTRY_ALLOW_FAILURE: true

      - name: Get build URL
        if: success()
        run: |
          echo "‚úÖ Build submitted successfully!"
          echo "Check build status at: https://expo.dev/accounts/akin-gulp/projects/migraine-tracker/builds"

      - name: Extract changelog for release notes
        if: success()
        id: changelog
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"

          # Read CHANGELOG.md and extract the section for unreleased changes
          if [ -f "CHANGELOG.md" ]; then
            # Extract everything between "Unreleased" and the next version header
            CHANGELOG_SECTION=$(awk '/#### Unreleased/,/^#### \[/ {if (/^#### \[/) exit; if (!/#### Unreleased/) print}' CHANGELOG.md | head -50)

            if [ -z "$CHANGELOG_SECTION" ]; then
              CHANGELOG_SECTION="No changelog available for this release."
            fi
          else
            CHANGELOG_SECTION="No changelog available for this release."
          fi

          # Save to output (handle multiline)
          {
            echo 'notes<<EOF'
            echo "$CHANGELOG_SECTION"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## MigraLog TestFlight Build

            **Release Type:** ${{ env.RELEASE_TYPE }}
            **Build Profile:** ${{ env.BUILD_PROFILE }}

            ### Changes in this Release

            ${{ steps.changelog.outputs.notes }}

            ---

            **Build Status:** https://expo.dev/accounts/akin-gulp/projects/migraine-tracker/builds
          draft: false
          prerelease: ${{ env.RELEASE_TYPE != 'production' }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Build failed. Check the logs above for details."
          echo "Common issues:"
          echo "  - EXPO_TOKEN not set or invalid"
          echo "  - App Store Connect credentials not configured in EAS"
          echo "  - Build profile configuration errors in eas.json"
